# ç”µå½±ä¸–ç•Œé¡¹ç›®æ¶æ„è®¾è®¡æ–‡æ¡£

## ç›®å½•
- [ç³»ç»Ÿæ¶æ„å›¾](#ç³»ç»Ÿæ¶æ„å›¾)
- [æŠ€æœ¯æ¶æ„å›¾](#æŠ€æœ¯æ¶æ„å›¾)
- [æ•°æ®åº“è®¾è®¡](#æ•°æ®åº“è®¾è®¡)
- [ä¸šåŠ¡æµç¨‹å›¾](#ä¸šåŠ¡æµç¨‹å›¾)
- [æ¨¡å—å…³ç³»å›¾](#æ¨¡å—å…³ç³»å›¾)

---

## ç³»ç»Ÿæ¶æ„å›¾

### æ•´ä½“æ¶æ„ï¼ˆä¸‰å±‚æ¶æ„ï¼‰

```mermaid
%%{init: {'theme': 'base', 'themeVariables': { 'background': '#ffffff', 'primaryColor': '#e3f2fd', 'primaryTextColor': '#1565c0', 'primaryBorderColor': '#90caf9', 'lineColor': '#64b5f6', 'secondaryColor': '#fff3e0', 'tertiaryColor': '#e8f5e9'}}}%%
graph TB
    subgraph client["ğŸ–¥ï¸ å®¢æˆ·ç«¯å±‚ Presentation Layer"]
        A1["Webæµè§ˆå™¨"]
        A2["ç§»åŠ¨æµè§ˆå™¨"]
        A3["å¹³æ¿æµè§ˆå™¨"]
    end
    
    subgraph app["âš™ï¸ åº”ç”¨å±‚ Application Layer"]
        B1["Express Server"]
        B2["è·¯ç”±æ§åˆ¶ Router"]
        B3["ä¸­é—´ä»¶ Middleware"]
        B4["æ¨¡æ¿å¼•æ“ EJS"]
        B5["ä¸šåŠ¡é€»è¾‘ Business Logic"]
    end
    
    subgraph data["ğŸ’¾ æ•°æ®å±‚ Data Layer"]
        C1[("MySQLæ•°æ®åº“")]
        C2["æ–‡ä»¶å­˜å‚¨ç³»ç»Ÿ"]
        C3["Sessionå­˜å‚¨"]
    end
    
    A1 --> B1
    A2 --> B1
    A3 --> B1
    
    B1 --> B2
    B2 --> B3
    B3 --> B4
    B3 --> B5
    
    B5 --> C1
    B5 --> C2
    B3 --> C3
```

### MVCæ¶æ„æ¨¡å¼

```mermaid
%%{init: {'theme': 'base', 'themeVariables': { 'background': '#ffffff', 'primaryColor': '#e8f5e9', 'primaryTextColor': '#2e7d32', 'primaryBorderColor': '#a5d6a7', 'lineColor': '#66bb6a'}}}%%
graph LR
    subgraph view["ğŸ“„ View è§†å›¾å±‚"]
        V1["EJSæ¨¡æ¿"]
        V2["HTML/CSS/JS"]
        V3["Bootstrapç»„ä»¶"]
    end
    
    subgraph controller["ğŸ® Controller æ§åˆ¶å™¨å±‚"]
        C1["è·¯ç”±å¤„ç†"]
        C2["è¯·æ±‚éªŒè¯"]
        C3["å“åº”å¤„ç†"]
    end
    
    subgraph model["ğŸ“¦ Model æ¨¡å‹å±‚"]
        M1["DataManager"]
        M2["æ•°æ®éªŒè¯"]
        M3["ä¸šåŠ¡é€»è¾‘"]
    end
    
    subgraph database["ğŸ—„ï¸ Database"]
        D1[("MySQL")]
    end
    
    V1 --> C1
    V2 --> C1
    V3 --> C1
    
    C1 --> C2
    C2 --> C3
    C3 --> V1
    
    C2 --> M1
    M1 --> M2
    M2 --> M3
    M3 --> D1
    
    D1 --> M3
    M3 --> C3
```

---

## æŠ€æœ¯æ¶æ„å›¾

### å‰åç«¯äº¤äº’æµç¨‹

```mermaid
%%{init: {'theme': 'base', 'themeVariables': { 'background': '#ffffff', 'primaryColor': '#e3f2fd', 'primaryTextColor': '#1565c0', 'actorBkg': '#e3f2fd', 'actorBorder': '#90caf9', 'actorTextColor': '#1565c0', 'signalColor': '#1976d2', 'signalTextColor': '#1565c0'}}}%%
sequenceDiagram
    participant Browser as ğŸŒ æµè§ˆå™¨
    participant Express as âš¡ ExpressæœåŠ¡å™¨
    participant Router as ğŸ”€ è·¯ç”±æ§åˆ¶å™¨
    participant Middleware as ğŸ” ä¸­é—´ä»¶
    participant Business as ğŸ’¼ ä¸šåŠ¡é€»è¾‘
    participant Database as ğŸ—„ï¸ MySQLæ•°æ®åº“
    
    Browser->>Express: HTTPè¯·æ±‚
    Express->>Router: è·¯ç”±åˆ†å‘
    Router->>Middleware: ä¸­é—´ä»¶å¤„ç†
    
    alt éœ€è¦è®¤è¯
        Middleware->>Middleware: SessionéªŒè¯
        Middleware-->>Browser: 401 æœªæˆæƒ
    else è®¤è¯é€šè¿‡
        Middleware->>Business: è°ƒç”¨ä¸šåŠ¡é€»è¾‘
        Business->>Database: æ•°æ®åº“æŸ¥è¯¢
        Database-->>Business: è¿”å›æ•°æ®
        Business->>Business: æ•°æ®å¤„ç†
        Business-->>Router: å¤„ç†ç»“æœ
        Router-->>Express: æ¸²æŸ“è§†å›¾/è¿”å›JSON
        Express-->>Browser: HTTPå“åº”
    end
```

### æŠ€æœ¯æ ˆå±‚æ¬¡å›¾

```mermaid
%%{init: {'theme': 'base', 'themeVariables': { 'background': '#ffffff', 'primaryColor': '#fff8e1', 'primaryTextColor': '#f57c00', 'primaryBorderColor': '#ffcc80', 'lineColor': '#ffa726'}}}%%
graph TD
    subgraph frontend["ğŸ¨ å‰ç«¯æŠ€æœ¯æ ˆ"]
        FE1["HTML5<br/>è¯­ä¹‰åŒ–æ ‡ç­¾"]
        FE2["CSS3<br/>å“åº”å¼å¸ƒå±€/åŠ¨ç”»"]
        FE3["JavaScript ES6+<br/>DOMæ“ä½œ/äº‹ä»¶å¤„ç†"]
        FE4["jQuery 3.7.1<br/>AJAX/é€‰æ‹©å™¨"]
        FE5["Bootstrap 5.3.0<br/>ç»„ä»¶åº“/ç½‘æ ¼ç³»ç»Ÿ"]
    end
    
    subgraph backend["ğŸ”§ åç«¯æŠ€æœ¯æ ˆ"]
        BE1["Node.js 18+<br/>è¿è¡Œæ—¶ç¯å¢ƒ"]
        BE2["Express 4.18.2<br/>Webæ¡†æ¶"]
        BE3["EJS 3.1.9<br/>æ¨¡æ¿å¼•æ“"]
        BE4["ä¸­é—´ä»¶<br/>body-parser/session"]
    end
    
    subgraph storage["ğŸ’¾ æ•°æ®å­˜å‚¨"]
        DB1[("MySQL 8.0<br/>å…³ç³»å‹æ•°æ®åº“")]
        DB2["mysql2<br/>æ•°æ®åº“é©±åŠ¨"]
        DB3["æ–‡ä»¶ç³»ç»Ÿ<br/>å›¾ç‰‡/è§†é¢‘å­˜å‚¨"]
    end
    
    subgraph tools["ğŸ› ï¸ å®‰å…¨ä¸å·¥å…·"]
        ST1["bcryptjs<br/>å¯†ç åŠ å¯†"]
        ST2["Multer<br/>æ–‡ä»¶ä¸Šä¼ "]
        ST3["Git<br/>ç‰ˆæœ¬æ§åˆ¶"]
        ST4["Nodemon<br/>çƒ­é‡è½½"]
    end
    
    FE1 --> FE2 --> FE3 --> FE4 --> FE5
    BE1 --> BE2 --> BE3
    BE2 --> BE4
    DB1 --> DB2 --> BE2
    ST1 & ST2 --> BE2
```

---

## æ•°æ®åº“è®¾è®¡

### ERå›¾ï¼ˆå®ä½“å…³ç³»å›¾ï¼‰

```mermaid
%%{init: {'theme': 'base', 'themeVariables': { 'background': '#ffffff', 'primaryColor': '#B8E0F6', 'primaryTextColor': '#000000', 'primaryBorderColor': '#4A90E2', 'lineColor': '#333333'}}}%%
graph TD
    %% ========== ç”¨æˆ·å®ä½“ ==========
    UserId((id)) --> Users[ç”¨æˆ·è¡¨<br/>USERS]
    UserName((username)) --> Users
    Users --> UserEmail((email))
    Users --> UserPwd((password))
    Users --> UserAvatar((avatar))
    
    %% ========== ç”¨æˆ·ä¸è¯„è®º/æ”¶è—çš„å…³ç³» ==========
    Users -->|1| PublishRel{å‘è¡¨}
    PublishRel -->|N| Comments[è¯„è®ºè¡¨<br/>COMMENTS]
    
    Users -->|1| FavRel{æ”¶è—}
    FavRel -->|N| Favorites[æ”¶è—è¡¨<br/>FAVORITES]
    
    %% ========== è¯„è®ºå®ä½“å±æ€§ ==========
    CommentId((id)) --> Comments
    Comments --> CommentContent((content))
    Comments --> CommentTime((created_at))
    Comments --> CommentParent((parent_id))
    
    %% ========== æ”¶è—å®ä½“å±æ€§ ==========
    FavId((id)) --> Favorites
    Favorites --> FavTime((created_at))
    
    %% ========== è¯„è®º/æ”¶è—ä¸ç”µå½±çš„å…³ç³» ==========
    Comments -->|N| BelongRel{å±äº}
    BelongRel -->|1| Movies[ç”µå½±è¡¨<br/>MOVIES]
    
    Favorites -->|N| FavToRel{å…³è”}
    FavToRel -->|1| Movies
    
    %% ========== ç”µå½±å®ä½“å±æ€§ ==========
    MovieId((id)) --> Movies
    MovieTitle((title)) --> Movies
    Movies --> MovieDesc((description))
    Movies --> MovieGenre((genre))
    Movies --> MovieYear((year))
    Movies --> MovieRating((rating))
    
    %% ========== æ ·å¼å®šä¹‰ ==========
    style Users fill:#B8E0F6,stroke:#4A90E2,stroke-width:2px,color:#000000
    style Movies fill:#B8E0F6,stroke:#4A90E2,stroke-width:2px,color:#000000
    style Comments fill:#B8E0F6,stroke:#4A90E2,stroke-width:2px,color:#000000
    style Favorites fill:#B8E0F6,stroke:#4A90E2,stroke-width:2px,color:#000000
    
    style PublishRel fill:#FFE6CC,stroke:#FF9933,stroke-width:2px,color:#000000
    style FavRel fill:#FFE6CC,stroke:#FF9933,stroke-width:2px,color:#000000
    style BelongRel fill:#FFE6CC,stroke:#FF9933,stroke-width:2px,color:#000000
    style FavToRel fill:#FFE6CC,stroke:#FF9933,stroke-width:2px,color:#000000
```

### æ•°æ®è¡¨å…³ç³»å›¾

```mermaid
%%{init: {'theme': 'base', 'themeVariables': { 'background': '#ffffff', 'primaryColor': '#e8eaf6', 'primaryTextColor': '#3949ab', 'primaryBorderColor': '#9fa8da', 'lineColor': '#5c6bc0'}}}%%
graph LR
    subgraph core["ğŸ“Š æ ¸å¿ƒè¡¨"]
        U["ğŸ‘¤ ç”¨æˆ·è¡¨ users<br/>ç”¨æˆ·ä¿¡æ¯/æƒé™"]
        M["ğŸ¬ ç”µå½±è¡¨ movies<br/>ç”µå½±ä¿¡æ¯/çŠ¶æ€"]
    end
    
    subgraph relation["ğŸ”— å…³è”è¡¨"]
        C["ğŸ’¬ è¯„è®ºè¡¨ comments<br/>ç”¨æˆ·è¯„è®º/è¯„åˆ†"]
        F["â¤ï¸ æ”¶è—è¡¨ favorites<br/>æ”¶è—å…³ç³»"]
    end
    
    U -->|"1:N"| C
    M -->|"1:N"| C
    U -->|"N:M"| F
    M -->|"N:M"| F
```

---

## è¯¦ç»†è¡¨ç»“æ„

### ç”¨æˆ·è¡¨ (users)

| å­—æ®µå | ç±»å‹ | é•¿åº¦ | çº¦æŸ | è¯´æ˜ |
|--------|------|------|------|------|
| id | INT | - | PRIMARY KEY, AUTO_INCREMENT | ç”¨æˆ·ID |
| username | VARCHAR | 50 | UNIQUE, NOT NULL | ç™»å½•è´¦å· |
| nickname | VARCHAR | 50 | NULL | ç”¨æˆ·æ˜µç§° |
| avatar | VARCHAR | 255 | NULL | å¤´åƒæ–‡ä»¶å |
| email | VARCHAR | 100 | UNIQUE, NOT NULL | ç”µå­é‚®ç®± |
| password | VARCHAR | 255 | NOT NULL | åŠ å¯†å¯†ç (bcrypt) |
| role | ENUM | - | DEFAULT 'user' | ç”¨æˆ·è§’è‰²(user/admin) |
| created_at | TIMESTAMP | - | DEFAULT CURRENT_TIMESTAMP | æ³¨å†Œæ—¶é—´ |
| updated_at | TIMESTAMP | - | DEFAULT CURRENT_TIMESTAMP ON UPDATE | æ›´æ–°æ—¶é—´ |

### ç”µå½±è¡¨ (movies)

| å­—æ®µå | ç±»å‹ | é•¿åº¦ | çº¦æŸ | è¯´æ˜ |
|--------|------|------|------|------|
| id | INT | - | PRIMARY KEY, AUTO_INCREMENT | ç”µå½±ID |
| title | VARCHAR | 100 | NOT NULL | ç”µå½±æ ‡é¢˜ |
| description | TEXT | - | NULL | ç”µå½±ç®€ä»‹ |
| genre | VARCHAR | 50 | NULL | ç±»å‹ |
| year | INT | - | NULL | ä¸Šæ˜ å¹´ä»½ |
| rating | DECIMAL | (3,1) | NULL | è¯„åˆ†(0.0-10.0) |
| poster_url | VARCHAR | 255 | NULL | æµ·æŠ¥URL |
| director | VARCHAR | 100 | NULL | å¯¼æ¼” |
| duration | INT | - | NULL | æ—¶é•¿(åˆ†é’Ÿ) |
| country | VARCHAR | 100 | NULL | å›½å®¶/åœ°åŒº |
| status | ENUM | - | DEFAULT 'active' | çŠ¶æ€(active/inactive) |
| created_at | TIMESTAMP | - | DEFAULT CURRENT_TIMESTAMP | åˆ›å»ºæ—¶é—´ |

### è¯„è®ºè¡¨ (comments)

| å­—æ®µå | ç±»å‹ | çº¦æŸ | è¯´æ˜ |
|--------|------|------|------|
| id | INT | PRIMARY KEY, AUTO_INCREMENT | è¯„è®ºID |
| user_id | INT | FOREIGN KEY â†’ users(id) ON DELETE CASCADE | ç”¨æˆ·ID |
| movie_id | INT | FOREIGN KEY â†’ movies(id) ON DELETE CASCADE | ç”µå½±ID |
| parent_id | INT | FOREIGN KEY â†’ comments(id) ON DELETE CASCADE, NULL | çˆ¶è¯„è®ºID(æ”¯æŒå›å¤) |
| content | TEXT | NOT NULL | è¯„è®ºå†…å®¹ |
| created_at | TIMESTAMP | DEFAULT CURRENT_TIMESTAMP | å‘å¸ƒæ—¶é—´ |
| updated_at | TIMESTAMP | DEFAULT CURRENT_TIMESTAMP ON UPDATE | æ›´æ–°æ—¶é—´ |

### æ”¶è—è¡¨ (favorites)

| å­—æ®µå | ç±»å‹ | çº¦æŸ | è¯´æ˜ |
|--------|------|------|------|
| id | INT | PRIMARY KEY, AUTO_INCREMENT | æ”¶è—ID |
| user_id | INT | FOREIGN KEY â†’ users(id) ON DELETE CASCADE | ç”¨æˆ·ID |
| movie_id | INT | FOREIGN KEY â†’ movies(id) ON DELETE CASCADE | ç”µå½±ID |
| created_at | TIMESTAMP | DEFAULT CURRENT_TIMESTAMP | æ”¶è—æ—¶é—´ |

> æ³¨ï¼šuser_id + movie_id ç»„åˆå”¯ä¸€ç´¢å¼•ï¼Œç¡®ä¿åŒä¸€ç”¨æˆ·ä¸èƒ½é‡å¤æ”¶è—åŒä¸€ç”µå½±

---

## ä¸šåŠ¡æµç¨‹å›¾

### ç”¨æˆ·æ³¨å†Œæµç¨‹

```mermaid
%%{init: {'theme': 'base', 'themeVariables': { 'background': '#ffffff', 'primaryColor': '#e3f2fd', 'primaryTextColor': '#1565c0', 'primaryBorderColor': '#90caf9', 'lineColor': '#42a5f5'}}}%%
flowchart TD
    Start(["ğŸš€ ç”¨æˆ·è®¿é—®æ³¨å†Œé¡µ"]) --> Input["ğŸ“ å¡«å†™æ³¨å†Œä¿¡æ¯"]
    Input --> Validate{"âœ… å‰ç«¯éªŒè¯"}
    
    Validate -->|"âŒ éªŒè¯å¤±è´¥"| ShowError1["âš ï¸ æ˜¾ç¤ºé”™è¯¯æç¤º"]
    ShowError1 --> Input
    
    Validate -->|"âœ“ éªŒè¯é€šè¿‡"| Submit["ğŸ“¤ æäº¤è¡¨å•"]
    Submit --> Backend["âš™ï¸ åç«¯æ¥æ”¶è¯·æ±‚"]
    Backend --> CheckUser{"ğŸ” æ£€æŸ¥ç”¨æˆ·å<br/>æ˜¯å¦å­˜åœ¨"}
    
    CheckUser -->|"å·²å­˜åœ¨"| Return1["âŒ è¿”å›é”™è¯¯ä¿¡æ¯"]
    Return1 --> ShowError2["âš ï¸ æ˜¾ç¤ºç”¨æˆ·åå·²å­˜åœ¨"]
    ShowError2 --> Input
    
    CheckUser -->|"ä¸å­˜åœ¨"| Encrypt["ğŸ” å¯†ç åŠ å¯†"]
    Encrypt --> SaveDB["ğŸ’¾ ä¿å­˜åˆ°æ•°æ®åº“"]
    SaveDB --> CreateSession["ğŸ« åˆ›å»ºSession"]
    CreateSession --> Redirect["ğŸ”„ è·³è½¬åˆ°é¦–é¡µ"]
    Redirect --> End(["âœ… æ³¨å†Œå®Œæˆ"])
```

### ç”¨æˆ·ç™»å½•æµç¨‹

```mermaid
%%{init: {'theme': 'base', 'themeVariables': { 'background': '#ffffff', 'primaryColor': '#e8f5e9', 'primaryTextColor': '#2e7d32', 'primaryBorderColor': '#a5d6a7', 'lineColor': '#66bb6a'}}}%%
flowchart TD
    Start(["ğŸš€ è®¿é—®ç™»å½•é¡µ"]) --> Input["ğŸ“ è¾“å…¥ç”¨æˆ·åå¯†ç "]
    Input --> Submit["ğŸ“¤ æäº¤ç™»å½•"]
    Submit --> Backend["âš™ï¸ åç«¯éªŒè¯"]
    Backend --> CheckUser{"ğŸ” æŸ¥è¯¢ç”¨æˆ·"}
    
    CheckUser -->|"ä¸å­˜åœ¨"| Error1["âŒ è¿”å›ç”¨æˆ·ä¸å­˜åœ¨"]
    Error1 --> ShowError["âš ï¸ æ˜¾ç¤ºé”™è¯¯æç¤º"]
    ShowError --> Input
    
    CheckUser -->|"å­˜åœ¨"| CheckPwd{"ğŸ” éªŒè¯å¯†ç "}
    CheckPwd -->|"é”™è¯¯"| Error2["âŒ è¿”å›å¯†ç é”™è¯¯"]
    Error2 --> ShowError
    
    CheckPwd -->|"æ­£ç¡®"| CreateSession["ğŸ« åˆ›å»ºSession"]
    CreateSession --> Remember{"ğŸ“Œ è®°ä½æˆ‘?"}
    Remember -->|"æ˜¯"| SetCookie["ğŸª è®¾ç½®æŒä¹…Cookie"]
    Remember -->|"å¦"| Skip["è·³è¿‡"]
    SetCookie --> Success
    Skip --> Success["âœ… ç™»å½•æˆåŠŸ"]
    Success --> Redirect["ğŸ”„ è·³è½¬ç›®æ ‡é¡µé¢"]
    Redirect --> End(["âœ… ç™»å½•å®Œæˆ"])
```

### ç”µå½±æ”¶è—æµç¨‹

```mermaid
%%{init: {'theme': 'base', 'themeVariables': { 'background': '#ffffff', 'primaryColor': '#fff3e0', 'primaryTextColor': '#e65100', 'primaryBorderColor': '#ffcc80', 'lineColor': '#ffa726'}}}%%
flowchart TD
    Start(["â¤ï¸ ç‚¹å‡»æ”¶è—æŒ‰é’®"]) --> CheckLogin{"ğŸ” æ˜¯å¦ç™»å½•?"}
    
    CheckLogin -->|"å¦"| ShowTip["âš ï¸ æç¤ºç™»å½•"]
    ShowTip --> RedirectLogin["ğŸ”„ è·³è½¬ç™»å½•é¡µ"]
    RedirectLogin --> LoginEnd(["ç»“æŸ"])
    
    CheckLogin -->|"æ˜¯"| SendRequest["ğŸ“¤ å‘é€AJAXè¯·æ±‚"]
    SendRequest --> Backend["âš™ï¸ åç«¯å¤„ç†"]
    Backend --> CheckFav{"ğŸ’› æ˜¯å¦å·²æ”¶è—?"}
    
    CheckFav -->|"å·²æ”¶è—"| DeleteFav["ğŸ—‘ï¸ åˆ é™¤æ”¶è—è®°å½•"]
    DeleteFav --> UpdateDB1["ğŸ’¾ æ›´æ–°æ•°æ®åº“"]
    UpdateDB1 --> Response1["ğŸ“¥ è¿”å›å–æ¶ˆæˆåŠŸ"]
    
    CheckFav -->|"æœªæ”¶è—"| AddFav["â• æ·»åŠ æ”¶è—è®°å½•"]
    AddFav --> UpdateDB2["ğŸ’¾ æ›´æ–°æ•°æ®åº“"]
    UpdateDB2 --> Response2["ğŸ“¥ è¿”å›æ”¶è—æˆåŠŸ"]
    
    Response1 --> UpdateUI1["ğŸ”˜ æ›´æ–°æŒ‰é’®çŠ¶æ€<br/>æ˜¾ç¤ºç©ºå¿ƒå›¾æ ‡"]
    Response2 --> UpdateUI2["â¤ï¸ æ›´æ–°æŒ‰é’®çŠ¶æ€<br/>æ˜¾ç¤ºå®å¿ƒå›¾æ ‡"]
    
    UpdateUI1 --> ShowToast1["ğŸ‰ æ˜¾ç¤ºToastæç¤º"]
    UpdateUI2 --> ShowToast2["ğŸ‰ æ˜¾ç¤ºToastæç¤º"]
    
    ShowToast1 --> End(["âœ… å®Œæˆ"])
    ShowToast2 --> End
```

### è¯„è®ºå‘è¡¨æµç¨‹

```mermaid
%%{init: {'theme': 'base', 'themeVariables': { 'background': '#ffffff', 'primaryColor': '#f3e5f5', 'primaryTextColor': '#7b1fa2', 'primaryBorderColor': '#ce93d8', 'lineColor': '#ab47bc'}}}%%
flowchart TD
    Start(["ğŸ’¬ è¾“å…¥è¯„è®ºå†…å®¹"]) --> Input["ğŸ“ å¡«å†™è¯„è®ºå’Œè¯„åˆ†"]
    Input --> Validate{"âœ… å‰ç«¯éªŒè¯"}
    
    Validate -->|"âŒ å†…å®¹ä¸ºç©º"| Error1["âš ï¸ æç¤ºè¾“å…¥å†…å®¹"]
    Error1 --> Input
    
    Validate -->|"âœ“ éªŒè¯é€šè¿‡"| CheckLogin{"ğŸ” æ˜¯å¦ç™»å½•?"}
    CheckLogin -->|"å¦"| Tip["âš ï¸ æç¤ºç™»å½•"]
    Tip --> RedirectLogin(["ğŸ”„ è·³è½¬ç™»å½•"])
    
    CheckLogin -->|"æ˜¯"| Submit["ğŸ“¤ æäº¤è¯„è®º"]
    Submit --> Backend["âš™ï¸ åç«¯å¤„ç†"]
    Backend --> SaveComment["ğŸ’¾ ä¿å­˜åˆ°æ•°æ®åº“"]
    SaveComment --> GetUserInfo["ğŸ‘¤ è·å–ç”¨æˆ·ä¿¡æ¯"]
    GetUserInfo --> Response["ğŸ“¥ è¿”å›è¯„è®ºæ•°æ®"]
    Response --> UpdateUI["ğŸ“‹ æ·»åŠ åˆ°è¯„è®ºåˆ—è¡¨"]
    UpdateUI --> ClearForm["ğŸ§¹ æ¸…ç©ºè¡¨å•"]
    ClearForm --> ShowSuccess["ğŸ‰ æ˜¾ç¤ºæˆåŠŸæç¤º"]
    ShowSuccess --> End(["âœ… å®Œæˆ"])
```

### ç®¡ç†å‘˜æ·»åŠ ç”µå½±æµç¨‹

```mermaid
%%{init: {'theme': 'base', 'themeVariables': { 'background': '#ffffff', 'primaryColor': '#e0f2f1', 'primaryTextColor': '#00695c', 'primaryBorderColor': '#80cbc4', 'lineColor': '#26a69a'}}}%%
flowchart TD
    Start(["ğŸ¬ ç‚¹å‡»æ·»åŠ ç”µå½±"]) --> Modal["ğŸ“‹ æ‰“å¼€æ¨¡æ€æ¡†"]
    Modal --> FillInfo["ğŸ“ å¡«å†™ç”µå½±ä¿¡æ¯"]
    FillInfo --> Upload{"ğŸ“ ä¸Šä¼ æ–‡ä»¶?"}
    
    Upload -->|"ä¸Šä¼ æµ·æŠ¥"| UploadPoster["ğŸ–¼ï¸ ä¸Šä¼ æµ·æŠ¥å›¾ç‰‡"]
    Upload -->|"ä¸Šä¼ è§†é¢‘"| UploadVideo["ğŸ¥ ä¸Šä¼ è§†é¢‘æ–‡ä»¶"]
    Upload -->|"è·³è¿‡"| Submit
    
    UploadPoster --> Submit["ğŸ“¤ æäº¤è¡¨å•"]
    UploadVideo --> Submit
    
    Submit --> Backend["âš™ï¸ åç«¯å¤„ç†"]
    Backend --> ValidateData{"âœ… éªŒè¯æ•°æ®"}
    
    ValidateData -->|"âŒ å¤±è´¥"| Error["âš ï¸ è¿”å›é”™è¯¯ä¿¡æ¯"]
    Error --> ShowError["âš ï¸ æ˜¾ç¤ºé”™è¯¯æç¤º"]
    ShowError --> FillInfo
    
    ValidateData -->|"âœ“ æˆåŠŸ"| SaveFile["ğŸ’¾ ä¿å­˜æ–‡ä»¶"]
    SaveFile --> SaveDB["ğŸ’¾ ä¿å­˜åˆ°æ•°æ®åº“"]
    SaveDB --> Response["ğŸ“¥ è¿”å›æˆåŠŸ"]
    Response --> CloseModal["â å…³é—­æ¨¡æ€æ¡†"]
    CloseModal --> RefreshList["ğŸ”„ åˆ·æ–°ç”µå½±åˆ—è¡¨"]
    RefreshList --> ShowSuccess["ğŸ‰ æ˜¾ç¤ºæˆåŠŸæç¤º"]
    ShowSuccess --> End(["âœ… å®Œæˆ"])
```

---

## æ¨¡å—å…³ç³»å›¾

### è·¯ç”±æ¨¡å—å…³ç³»

```mermaid
%%{init: {'theme': 'base', 'themeVariables': { 'background': '#ffffff', 'primaryColor': '#e1f5fe', 'primaryTextColor': '#0277bd', 'primaryBorderColor': '#81d4fa', 'lineColor': '#29b6f6'}}}%%
graph TD
    Server["ğŸš€ server.js<br/>Expressä¸»ç¨‹åº"] --> IndexRoute["ğŸ  index.js<br/>é¦–é¡µè·¯ç”±"]
    Server --> MoviesRoute["ğŸ¬ movies.js<br/>ç”µå½±è·¯ç”±"]
    Server --> AuthRoute["ğŸ” auth.js<br/>è®¤è¯è·¯ç”±"]
    Server --> UserRoute["ğŸ‘¤ user.js<br/>ç”¨æˆ·è·¯ç”±"]
    Server --> APIRoute["ğŸ“¡ api.js<br/>APIè·¯ç”±"]
    Server --> AdminRoute["ğŸ‘‘ admin.js<br/>ç®¡ç†å‘˜è·¯ç”±"]
    Server --> DebugRoute["ğŸ”§ debug.js<br/>è°ƒè¯•è·¯ç”±"]
    
    IndexRoute --> DataManager["ğŸ“¦ dataManager.js<br/>æ•°æ®ç®¡ç†"]
    MoviesRoute --> DataManager
    AuthRoute --> DataManager
    UserRoute --> DataManager
    APIRoute --> DataManager
    AdminRoute --> DataManager
    
    AuthRoute --> AuthUtil["ğŸ”‘ auth.js<br/>è®¤è¯å·¥å…·"]
    UserRoute --> AuthUtil
    AdminRoute --> AuthUtil
    
    Server --> Middleware["âš™ï¸ ä¸­é—´ä»¶"]
    Middleware --> Session["ğŸ« express-session"]
    Middleware --> Cookie["ğŸª cookie-parser"]
    Middleware --> BodyParser["ğŸ“‹ body-parser"]
    Middleware --> Multer["ğŸ“ multeræ–‡ä»¶ä¸Šä¼ "]
    
    DataManager --> Database[("ğŸ—„ï¸ MySQLæ•°æ®åº“")]
```

### è§†å›¾æ¨¡æ¿å…³ç³»

```mermaid
%%{init: {'theme': 'base', 'themeVariables': { 'background': '#ffffff', 'primaryColor': '#fce4ec', 'primaryTextColor': '#c2185b', 'primaryBorderColor': '#f48fb1', 'lineColor': '#ec407a'}}}%%
graph TD
    Pages["ğŸ“ é¡µé¢æ¨¡æ¿ pages/"] --> Index["ğŸ  index.ejs é¦–é¡µ"]
    Pages --> Movies["ğŸ¬ movies.ejs ç”µå½±åˆ—è¡¨"]
    Pages --> Detail["ğŸ“„ movie-detail.ejs ç”µå½±è¯¦æƒ…"]
    Pages --> Play["â–¶ï¸ play.ejs æ’­æ”¾é¡µ"]
    Pages --> Search["ğŸ” search.ejs æœç´¢é¡µ"]
    Pages --> Login["ğŸ” login.ejs ç™»å½•é¡µ"]
    Pages --> Register["ğŸ“ register.ejs æ³¨å†Œé¡µ"]
    Pages --> Profile["ğŸ‘¤ profile.ejs ä¸ªäººä¸­å¿ƒ"]
    Pages --> Admin["ğŸ‘‘ admin-dashboard.ejs ç®¡ç†åå°"]
    Pages --> Error["âŒ error.ejs é”™è¯¯é¡µ"]
    
    Header["ğŸ© partials/header.ejs"]
    Aside["ğŸ“Š partials/aside.ejs"]
    Footer["ğŸ¦¶ partials/footer.ejs"]
    
    Index & Movies & Detail & Play & Search & Login & Register & Profile & Admin & Error --> Header
    Index & Movies & Detail & Search --> Aside
    Index & Movies & Detail & Play & Search & Login & Register & Profile & Admin & Error --> Footer
```

### æ–‡ä»¶å­˜å‚¨ç»“æ„

```mermaid
%%{init: {'theme': 'base', 'themeVariables': { 'background': '#ffffff', 'primaryColor': '#fff8e1', 'primaryTextColor': '#ff8f00', 'primaryBorderColor': '#ffe082', 'lineColor': '#ffca28'}}}%%
graph TD
    Public["ğŸ“ public/ é™æ€èµ„æº"] --> CSS["ğŸ¨ css/"]
    Public --> JS["âš¡ js/"]
    Public --> Images["ğŸ–¼ï¸ images/"]
    Public --> Uploads["ğŸ“¤ uploads/"]
    Public --> Video["ğŸ¥ vedio/"]
    
    CSS --> StyleCSS["style.css è‡ªå®šä¹‰æ ·å¼"]
    JS --> MainJS["main.js è‡ªå®šä¹‰è„šæœ¬"]
    
    Images --> MoviePosters["ç”µå½±æµ·æŠ¥ 1.jpg~13.jpg"]
    Images --> DefaultImages["é»˜è®¤å›¾ç‰‡"]
    
    Uploads --> Avatars["ğŸ‘¤ avatars/ ç”¨æˆ·å¤´åƒ"]
    Uploads --> Posters["ğŸ–¼ï¸ posters/ ç”µå½±æµ·æŠ¥"]
    
    Video --> VideoFiles["ğŸ¥ è§†é¢‘æ–‡ä»¶ *.mp4"]
```

---

## æ•°æ®æµå›¾

### ç”¨æˆ·è¯·æ±‚æ•°æ®æµ

```mermaid
%%{init: {'theme': 'base', 'themeVariables': { 'background': '#ffffff', 'primaryColor': '#e8eaf6', 'primaryTextColor': '#3949ab', 'primaryBorderColor': '#9fa8da', 'lineColor': '#5c6bc0'}}}%%
flowchart LR
    User["ğŸ‘¤ ç”¨æˆ·"] -->|"HTTPè¯·æ±‚"| Express["âš¡ ExpressæœåŠ¡å™¨"]
    Express -->|"è·¯ç”±åˆ†å‘"| Router["ğŸ”€ è·¯ç”±æ§åˆ¶å™¨"]
    Router -->|"SessionéªŒè¯"| Middleware["ğŸ” è®¤è¯ä¸­é—´ä»¶"]
    
    Middleware -->|"âœ“ éªŒè¯é€šè¿‡"| Controller["ğŸ® ä¸šåŠ¡æ§åˆ¶å™¨"]
    Middleware -->|"âŒ éªŒè¯å¤±è´¥"| Error401["âš ï¸ 401æœªæˆæƒ"]
    Error401 -->|"è·³è½¬"| Login["ğŸ” ç™»å½•é¡µ"]
    
    Controller -->|"è°ƒç”¨"| DataManager["ğŸ“¦ æ•°æ®ç®¡ç†å™¨"]
    DataManager -->|"SQLæŸ¥è¯¢"| MySQL[("ğŸ—„ï¸ MySQLæ•°æ®åº“")]
    MySQL -->|"è¿”å›æ•°æ®"| DataManager
    DataManager -->|"å¤„ç†æ•°æ®"| Controller
    
    Controller -->|"æ¸²æŸ“"| EJS["ğŸ“„ EJSæ¨¡æ¿å¼•æ“"]
    EJS -->|"ç”ŸæˆHTML"| Express
    Express -->|"HTTPå“åº”"| User
```

### AJAXå¼‚æ­¥æ•°æ®æµ

```mermaid
%%{init: {'theme': 'base', 'themeVariables': { 'background': '#ffffff', 'primaryColor': '#e0f7fa', 'primaryTextColor': '#00838f', 'primaryBorderColor': '#80deea', 'lineColor': '#26c6da'}}}%%
flowchart LR
    Browser["ğŸŒ æµè§ˆå™¨JavaScript"] -->|"AJAXè¯·æ±‚"| API["ğŸ“¡ APIè·¯ç”±"]
    API -->|"éªŒè¯"| Auth["ğŸ” è®¤è¯ä¸­é—´ä»¶"]
    
    Auth -->|"âœ“ é€šè¿‡"| Logic["ğŸ’¼ ä¸šåŠ¡é€»è¾‘"]
    Auth -->|"âŒ å¤±è´¥"| JSON401["âš ï¸ è¿”å›401 JSON"]
    
    Logic -->|"æŸ¥è¯¢/æ›´æ–°"| DB[("ğŸ—„ï¸ MySQL")]
    DB -->|"æ•°æ®"| Logic
    Logic -->|"å¤„ç†"| Result["ğŸ“¦ å¤„ç†ç»“æœ"]
    Result -->|"JSONå“åº”"| API
    API -->|"è¿”å›"| Browser
    
    Browser -->|"æ›´æ–°DOM"| UI["ğŸ–¼ï¸ æ›´æ–°ç•Œé¢"]
    Browser -->|"æ˜¾ç¤º"| Toast["ğŸ‰ Toastæç¤º"]
    
    JSON401 -->|"æç¤º"| Browser
```

---

## å®‰å…¨æ¶æ„

### å®‰å…¨é˜²æŠ¤ä½“ç³»

```mermaid
%%{init: {'theme': 'base', 'themeVariables': { 'background': '#ffffff', 'primaryColor': '#ffebee', 'primaryTextColor': '#c62828', 'primaryBorderColor': '#ef9a9a', 'lineColor': '#ef5350'}}}%%
graph TD
    subgraph input["ğŸ›¡ï¸ è¾“å…¥å®‰å…¨"]
        Input["ç”¨æˆ·è¾“å…¥"] --> XSS["ğŸ”’ XSSé˜²æŠ¤<br/>EJSè‡ªåŠ¨è½¬ä¹‰"]
        Input --> SQLInjection["ğŸ”’ SQLæ³¨å…¥é˜²æŠ¤<br/>å‚æ•°åŒ–æŸ¥è¯¢"]
        Input --> CSRF["ğŸ”’ CSRFé˜²æŠ¤<br/>Sessionä»¤ç‰Œ"]
    end
    
    subgraph auth["ğŸ” è®¤è¯å®‰å…¨"]
        Password["å¯†ç å¤„ç†"] --> Bcrypt["ğŸ”‘ bcryptjsåŠ å¯†<br/>ä¸å¯é€†åŠ å¯†"]
        Session["ä¼šè¯ç®¡ç†"] --> SessionStore["ğŸ« Sessionå­˜å‚¨<br/>express-session"]
        SessionStore --> Cookie["ğŸª Cookieè®¾ç½®<br/>HttpOnly/Secure"]
    end
    
    subgraph file["ğŸ“ æ–‡ä»¶å®‰å…¨"]
        FileUpload["æ–‡ä»¶ä¸Šä¼ "] --> FileType["âœ… æ–‡ä»¶ç±»å‹éªŒè¯"]
        FileUpload --> FileSize["âœ… æ–‡ä»¶å¤§å°é™åˆ¶"]
        FileUpload --> FileName["âœ… æ–‡ä»¶åå¤„ç†<br/>æ—¶é—´æˆ³é‡å‘½å"]
    end
    
    subgraph access["ğŸšª è®¿é—®æ§åˆ¶"]
        API["APIæ¥å£"] --> AuthMid["ğŸ” è®¤è¯ä¸­é—´ä»¶<br/>requireAuth"]
        AuthMid --> Permission["ğŸ‘‘ æƒé™éªŒè¯<br/>requireAdmin"]
    end
```

---

## éƒ¨ç½²æ¶æ„

### ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²æ¶æ„

```mermaid
%%{init: {'theme': 'base', 'themeVariables': { 'background': '#ffffff', 'primaryColor': '#e8f5e9', 'primaryTextColor': '#2e7d32', 'primaryBorderColor': '#a5d6a7', 'lineColor': '#66bb6a'}}}%%
graph TB
    subgraph internet["ğŸŒ äº’è”ç½‘"]
        Users["ğŸ‘¥ äº’è”ç½‘ç”¨æˆ·"]
    end
    
    subgraph lb["âš–ï¸ è´Ÿè½½å‡è¡¡å±‚"]
        LB["Nginxè´Ÿè½½å‡è¡¡å™¨"]
    end
    
    subgraph app["âš™ï¸ åº”ç”¨æœåŠ¡å±‚"]
        APP1["ğŸŸ¢ Node.jså®ä¾‹1"]
        APP2["ğŸŸ¢ Node.jså®ä¾‹2"]
        APP3["ğŸŸ¢ Node.jså®ä¾‹3"]
    end
    
    subgraph data["ğŸ’¾ æ•°æ®å­˜å‚¨å±‚"]
        DB[("ğŸ—„ï¸ MySQLä¸»åº“")]
        DBSlave[("ğŸ“‹ MySQLä»åº“")]
        Redis[("âš¡ Redisç¼“å­˜")]
        FileStorage["ğŸ“ æ–‡ä»¶å­˜å‚¨<br/>NFS/OSS"]
    end
    
    Users --> LB
    LB --> APP1 & APP2 & APP3
    
    APP1 & APP2 & APP3 --> DB
    APP1 & APP2 & APP3 --> Redis
    APP1 & APP2 & APP3 --> FileStorage
    
    DB --> DBSlave
```

---

## æ€»ç»“

æœ¬æ–‡æ¡£è¯¦ç»†æè¿°äº†ç”µå½±ä¸–ç•Œé¡¹ç›®çš„å„ä¸ªæ¶æ„å±‚é¢ï¼š

| ç« èŠ‚ | æè¿° |
|------|------|
| ğŸ“Š ç³»ç»Ÿæ¶æ„ | ä¸‰å±‚æ¶æ„å’ŒMVCæ¨¡å¼ |
| ğŸ”§ æŠ€æœ¯æ¶æ„ | å‰åç«¯æŠ€æœ¯æ ˆå’Œäº¤äº’æµç¨‹ |
| ğŸ—„ï¸ æ•°æ®åº“è®¾è®¡ | ERå›¾å’Œè¯¦ç»†è¡¨ç»“æ„ |
| ğŸ”„ ä¸šåŠ¡æµç¨‹ | æ ¸å¿ƒä¸šåŠ¡çš„æµç¨‹å›¾ |
| ğŸ“¦ æ¨¡å—å…³ç³» | ä»£ç æ¨¡å—çš„ç»„ç»‡å…³ç³» |
| ğŸ”€ æ•°æ®æµ | è¯·æ±‚å“åº”çš„æ•°æ®æµè½¬ |
| ğŸ” å®‰å…¨æ¶æ„ | å®Œæ•´çš„å®‰å…¨é˜²æŠ¤ä½“ç³» |
| ğŸš€ éƒ¨ç½²æ¶æ„ | ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²æ–¹æ¡ˆ |

è¿™äº›å›¾è¡¨æ¸…æ™°åœ°å±•ç¤ºäº†é¡¹ç›®çš„æ•´ä½“è®¾è®¡æ€è·¯å’ŒæŠ€æœ¯å®ç°ç»†èŠ‚ï¼Œä¸ºé¡¹ç›®çš„å¼€å‘ã€ç»´æŠ¤å’Œæ‰©å±•æä¾›äº†å®Œæ•´çš„å‚è€ƒã€‚
